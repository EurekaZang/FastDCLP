# 使用指南：FastTD3 模型播放和评估工具

本指南将帮助你使用已创建的工具来播放和评估训练好的 FastTD3 模型。

## 工具概览

我们已经创建了以下工具：

1. **play_isaac_lab.py** - 完整的模型播放工具（推荐）
2. **simple_play.py** - 简化的快速测试工具
3. **evaluate_model.py** - 命令行评估工具
4. **play_isaaclab_env.py** - 评估环境包装器
5. **model_evaluation_notebook.ipynb** - Jupyter 笔记本界面

## 快速开始

### 1. 使用简化播放脚本（推荐初学者）

```bash
cd /home/unnc/FastTD3/fast_td3/environments
python simple_play.py path/to/your/model.pt Isaac-Velocity-Flat-H1-v0 3
```

参数说明：
- `path/to/your/model.pt`: 你的训练模型路径
- `Isaac-Velocity-Flat-H1-v0`: 任务名称
- `3`: 播放的集数（可选，默认3集）

### 2. 使用完整播放工具

```bash
cd /home/unnc/FastTD3/fast_td3/environments
python play_isaac_lab.py --model_path path/to/your/model.pt --task Isaac-Velocity-Flat-H1-v0 --episodes 5
```

可用参数：
- `--model_path`: 模型文件路径
- `--task`: IsaacLab 任务名称
- `--episodes`: 播放集数（默认3）
- `--device`: 设备（cuda/cpu，自动检测）
- `--render_mode`: 渲染模式（human/rgb_array）
- `--record_video`: 是否录制视频
- `--video_path`: 视频保存路径

### 3. 命令行评估

```bash
cd /home/unnc/FastTD3/fast_td3/environments
python evaluate_model.py path/to/your/model.pt Isaac-Velocity-Flat-H1-v0 --episodes 10 --save_results results.json
```

### 4. Jupyter 笔记本

启动 Jupyter：
```bash
cd /home/unnc/FastTD3/fast_td3/environments
jupyter notebook model_evaluation_notebook.ipynb
```

## 环境要求

确保你已经安装了以下依赖：

```bash
# 基础依赖
pip install torch torchvision
pip install gymnasium
pip install numpy matplotlib

# IsaacLab 相关（如果使用）
# 按照 IsaacLab 官方文档安装

# 视频录制（可选）
pip install opencv-python imageio
```

## 常见问题解决

### 1. 模型加载失败
- 检查模型文件路径是否正确
- 确保模型是用 FastTD3 训练的
- 检查设备兼容性（CUDA vs CPU）

### 2. 环境创建失败
- 确保 IsaacLab 正确安装
- 检查任务名称是否正确
- 确认 GPU 驱动和 CUDA 版本

### 3. 渲染问题
- 如果 GUI 不显示，尝试设置 `headless=False`
- 如果是远程服务器，使用 `render_mode="rgb_array"`
- 检查显示服务器配置

## 模型文件结构

你的模型文件应该包含：
```python
{
    'actor_state_dict': ...,        # Actor 网络权重
    'critic_state_dict': ...,       # Critic 网络权重（可选）
    'obs_normalizer_state': ...,    # 观察归一化器（可选）
    'act_normalizer_state': ...,    # 动作归一化器（可选）
    'args': {                       # 训练参数
        'n_obs': 1090,
        'n_act': 2,
        'actor_hidden_dim': 512,
        ...
    }
}
```

## 支持的任务

常见的 IsaacLab 任务：
- `Isaac-Velocity-Flat-H1-v0`
- `Isaac-Velocity-Rough-H1-v0`
- `Isaac-Reach-Franka-v0`
- `Isaac-Lift-Cube-Franka-v0`

## 自定义使用

如果需要自定义播放逻辑，可以直接使用 `PlayIsaacLabEnv` 类：

```python
from play_isaaclab_env import PlayIsaacLabEnv

# 创建环境
env = PlayIsaacLabEnv(
    task_name="Isaac-Velocity-Flat-H1-v0",
    device="cuda",
    num_envs=1,
    render_mode="human"
)

# 加载模型并播放
results = env.evaluate_model("path/to/model.pt", num_episodes=5)
print(f"平均奖励: {results['mean_reward']:.2f}")
```

## 故障排除

如果遇到问题：

1. 检查所有路径是否正确
2. 确认所有依赖已安装
3. 查看终端错误信息
4. 尝试使用简化版本的脚本

## 下一步

1. 使用简化脚本测试你的第一个模型
2. 如果成功，尝试使用完整功能的工具
3. 使用 Jupyter 笔记本进行详细分析
4. 根据需要自定义评估指标

祝你使用愉快！如果有任何问题，请查看代码注释或寻求帮助。
